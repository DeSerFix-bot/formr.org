!function(a){"use strict";function b(b){this.run=b,this.block=a('<div class="run_unit row"></div>'),b.form.find(".run_units").append(this.block)}function c(c){"undefined"==typeof this.autosaved&&(this.lastSave=a.now(),this.autosaved=!1),this.form=c,this.form.submit(function(){return!1}),this.name=this.form.find(".run_name").val(),this.url=this.form.prop("action"),this.units=[];for(var d=a.parseJSON(this.form.attr("data-units")),e=0;e<d.length;e++)this.units[e]=new b(this),this.loadUnit(d[e],this.units[e]);var f=this;this.form.find("a.add_run_unit").click(function(b){b.preventDefault();var c=a(this).attr("href");return f.addUnit(c),!1}),this.form.find("a.public-toggle").click(this.publicToggle),this.exporter_button=this.form.find("a.export_run_units"),this.exporter_button.click(a.proxy(this.exportUnits,this)),this.importer_button=this.form.find("a.import_run_units"),this.importer_button.click(a.proxy(this.importUnits,this)),this.panic_button=a("#btn-panic"),this.panic_button.click(a.proxy(this.panic,this)),this.reorder_button=this.form.find("a.reorder_units"),this.reorder_button.attr("disabled","disabled").click(a.proxy(this.reorderUnits,this)),this.lock_toggle=this.form.find("a.lock-toggle"),this.lock(this.lock_toggle.hasClass("btn-checked"),this.form),this.lock_toggle.click(function(b){b.preventDefault();var c=a(this),d=c.hasClass("btn-checked")?0:1;return c.toggleClass("btn-checked",d),f.lock(!!d,f.form),a.ajax({url:c.attr("href"),dataType:"html",method:"POST",data:{on:d}}).fail(ajaxErrorHandling),!1}),window.onbeforeunload=a.proxy(function(){var b=!1;return a(this.units).each(function(a,c){return c.position_changed||c.unsavedChanges?(b=!0,!1):void 0}),b?"You have unsaved changes.":void 0},this)}b.prototype.init=function(b){this.block.htmlPolyfill(a(a.parseHTML(b))),this.position=this.block.find(".run_unit_position input.position"),this.position_changed=!1,this.position.change(a.proxy(this.position_changes,this)),this.dialog_inputs=this.block.find("div.run_unit_dialog input,div.run_unit_dialog select, div.run_unit_dialog button, div.run_unit_dialog textarea"),this.description=this.block.find(".run_unit_description"),this.unit_id=this.dialog_inputs.filter("input[name=unit_id]").val(),this.run_unit_id=this.dialog_inputs.filter("input[name=run_unit_id]").val(),this.special=this.dialog_inputs.filter("input[name=special]").val(),this.block.attr("id","run_unit_"+this.run_unit_id),this.dialog_inputs.on("input change",a.proxy(this.changes,this)),this.description.on("input change",a.proxy(this.changes,this)),this.save_inputs=this.dialog_inputs.add(this.position).add(this.description),this.block.find(".hastooltip").tooltip({container:"body"}),this.block.find(".select2").select2();var c=this.block.find("input.select2recipient");if(c.length>0&&!c.select2("container").hasClass("select2-container")){var d,e=c.attr("data-select2init");d="object"!=typeof e?a.parseJSON(e):e,c.select2({createSearchChoice:function(b,c){return 0===a(c).filter(function(){return 0===this.text.localeCompare(b)}).length?{id:b,text:b}:void 0},initSelection:function(b,c){var e;e={id:b.val(),text:b.val()},a.each(d,function(a,c){return c.id===b.val()?(e=c,!1):void 0}),c(e)},data:d})}this.unsavedChanges=!1,this.save_button=this.block.find("a.unit_save"),this.block.find("button.from_days").click(function(b){b.preventDefault();var c=a(this).closest(".input-group").find("input[type=number]"),d=c.val();c.val(60*d*24).change()}),this.test_button=this.block.find("a.unit_test"),this.test_button.click(a.proxy(this.test,this)),this.remove_button=this.block.find("button.remove_unit_from_run"),this.remove_button.click(a.proxy(this.removeFromRun,this)).mouseenter(function(){a(this).addClass("btn-danger")}).mouseleave(function(){a(this).removeClass("btn-danger")});var f=this.block.find("textarea");f[0]&&(this.textarea=a(f[0]),this.session=this.hookAceToTextarea(this.textarea)),f[1]&&(this.textarea2=a(f[1]),this.session2=this.hookAceToTextarea(this.textarea2)),this.run.lock(this.run.lock_toggle.hasClass("btn-checked"),this.block),this.save_button.attr("disabled",!0).removeClass("btn-info").text("Saved").click(a.proxy(this.save,this))},b.prototype.position_changes=function(a){this.position_changed||(this.position_changed=!0,this.run.reorder_button.addClass("btn-info").removeAttr("disabled")),this.position.parent().addClass("pos_changed")},b.prototype.changes=function(a){this.unsavedChanges||(this.unsavedChanges=!0,this.save_button.addClass("btn-info").removeAttr("disabled").text("Unsaved changesâ€¦"),this.test_button.attr("disabled","disabled"))},b.prototype.test=function(b){b.preventDefault();var c=this.test_button.text();this.test_button.attr("disabled",!0).html(c+bootstrap_spinner());this.block;return a.ajax({url:this.run.url+"/"+this.test_button.attr("href"),dataType:"html",data:{run_unit_id:this.run_unit_id,special:this.special},method:"GET"}).done(a.proxy(function(b){var d=bootstrap_modal("Test Results",b);a(".opencpu_accordion",d).collapse({toggle:!0}),this.test_button.html(c).removeAttr("disabled");var e=d.find("pre code");Array.prototype.forEach.call(e,hljs.highlightBlock),d.find(".download_r_code").length>0&&d.find(".download_r_code").click(function(){return download_next_textarea(this)})},this)).fail(a.proxy(function(a,b,d,e){this.test_button.attr("disabled",!1).html(c),ajaxErrorHandling(a,b,d,e)},this)),!1},b.prototype.save=function(b){b.preventDefault();var c=this.save_button.text();this.save_button.attr("disabled","disabled").html(c+bootstrap_spinner()),this.session&&this.textarea.val(this.session.getValue()),this.session2&&this.textarea2.val(this.session2.getValue());this.block;return a.ajax({url:this.run.url+"/"+this.save_button.attr("href"),dataType:"html",data:this.save_inputs.serialize(),method:"POST"}).done(a.proxy(function(b){""!==b?a.proxy(this.init(b),this):(this.save_button.attr("disabled",!0).removeClass("btn-info").text("Saved").click(a.proxy(this.save,this)),this.unsavedChanges=!1,this.test_button.removeAttr("disabled"))},this)).fail(a.proxy(function(a,b,d,e){this.save_button.removeAttr("disabled").html(c),ajaxErrorHandling(a,b,d,e)},this)),!1},b.prototype.hookAceToTextarea=function(b){var c=b.data("editor"),d=a("<div>",{position:"absolute",width:b.width(),height:b.height(),"class":b.attr("class")}).insertBefore(b);b.css("display","none"),this.editor=ace.edit(d[0]),this.editor.setOptions({minLines:b.attr("rows")?b.attr("rows"):3,maxLines:30}),this.editor.setTheme("ace/theme/textmate"),this.editor.$blockScrolling=1/0;var e=this.editor.getSession();return e.setValue(b.val()),this.editor.renderer.setShowGutter(!1),e.setUseWrapMode(!0),e.setWrapLimitRange(42,42),e.setMode("ace/mode/"+c),this.editor.on("change",a.proxy(this.changes,this)),e},b.prototype.removeFromRun=function(b,c){b.preventDefault(),a(".tooltip").hide();var d,e=this,f=b,g=this.block,h=this.run.url+"/"+this.remove_button.attr("href"),i={run_unit_id:this.run_unit_id};return"yes"===c&&(i.confirm="yes"),g.hide(),a.ajax({url:h,dataType:"html",data:i,method:"POST"}).done(a.proxy(function(b){if(g.show(),b)if("warn"===b)d=a(a.parseHTML(getHTMLTemplate("tpl-confirmation",{content:"Are you sure you want to delete this run unit and all it's data?"}))),d.on("shown.bs.modal",function(){d.find(".btn-yes").click(function(a){e.removeFromRun(f,"yes"),d.modal("hide")}),d.find(".btn-no").click(function(a){d.modal("hide"),e.removeFromRun(f,"no")})}).on("hidden.bs.modal",function(){d.remove()}).modal("show");else{g.html(b),g.show();var c=this.run.units.indexOf(this);c>-1&&this.run.units.splice(c,1)}},this)).fail(function(a,b,c,d){g.show(),ajaxErrorHandling(a,b,c,d)}),!1},b.prototype.serialize=function(){var a=this.save_inputs.serializeArray(),b={};b.type=this.block.find(".run_unit_inner").data("type");for(var c=0;c<a.length;c++)"unit_id"!=a[c].name&&"run_unit_id"!=a[c].name&&"position"!=a[c].name.substr(0,8)?b[a[c].name]=a[c].value:"position"==a[c].name.substr(0,8)&&(b.position=a[c].value);return b},c.prototype.getMaxPosition=function(){var b=null;return a(this.units).each(function(a,c){var d=+c.position.val();null===b?b=d:d>b&&(b=d)}),null===b&&(b=0),b},c.prototype.loadUnit=function(b,c){a.ajax({url:this.url+"/ajax_get_unit",data:b,dataType:"html",success:a.proxy(function(a,b){c.init(a)},this)})},c.prototype.addUnit=function(c){var d=this.getMaxPosition(),e=new b(this);this.units.push(e),a.ajax({url:c,dataType:"html",method:"POST",data:{position:d+10}}).done(a.proxy(function(a){e.init(a)},this)).fail(ajaxErrorHandling)},c.prototype.exportUnits=function(){var b={},c=this.url,d=!1,e=a("<div />"),f=this.lock_toggle.hasClass("btn-checked");f&&this.lock(!1,this.form);for(var g=0;g<this.units.length;g++){var h=this.units[g].serialize();h.unit_id=this.units[g].unit_id,h.run_unit_id=this.units[g].run_unit_id,d=d||this.units[g].unsavedChanges,b[h.position]=h,e.append(a(a.parseHTML(getHTMLTemplate("tpl-export-unit-block",{unit_pos:h.position,unit_json:JSON.stringify(h,null,"	")}))))}if(f&&this.lock(f,this.form),d)return void bootstrap_modal("Please save all changes before export.","Unsaved Changes");var i=e.html(),j=a(a.parseHTML(getHTMLTemplate("tpl-export-units",{run_name:this.name,export_html:i})));j.find("form#export_run_units").attr("action",c+"/export"),j.on("shown.bs.modal",function(){j.find(".confirm-export").click(function(c){var d=a.trim(j.find("input[name=export_name]").val()),e=/^[a-z0-9_\s]+$/i;if(!d||!e.test(d))return bootstrap_alert("Enter a valid export name","Export name invalid.",".run_export_before_alert"),!1;var f={},g=j.find(".run-export-unit-block");return g.each(function(){var c=a(this).find(".select"),d=parseInt(c.data("selected"),10),e=parseInt(c.data("position"),10);!d||isNaN(d)||isNaN(e)||(f[e]=b[e])}),a.isEmptyObject(f)?(bootstrap_alert("You need to select at least one unit to export.","Nothing chosen.",".run_export_before_alert"),!1):(j.find("input[name=units]").val(JSON.stringify(f)),window.setTimeout(function(){j.find(".cancel-export").trigger("click")},100),!0)})}).on("hidden.bs.modal",function(){j.remove()}).modal("show");var k=j.find("pre code");k.each(function(){var b=a(this);hljs.highlightBlock(b.get(0)),b.parents(".run-export-unit-block").find(".select").on("click",function(){var b=a(this),c=parseInt(b.data("selected"),10);c?(b.data("selected",0),b.find("i").removeClass("fa-check")):(b.data("selected",1),b.find("i").addClass("fa-check"))})})},c.prototype.importUnits=function(){var b=a("#run-import-modal-dialog");return b.length?b.modal("show"):void a.get(this.url+"/ajax_run_import",{dialog:!0},function(c){b=a(a.parseHTML(getHTMLTemplate("tpl-import-units",{content:c}))).attr("id","run-import-modal-dialog"),b.find("select").bind("change",function(){var c=parseInt(a(this).val(),10);if(!isNaN(c)){var d="selected-run-export-"+c,e=getHTMLTemplate(d);b.find("textarea").val(JSON.stringify(a.parseJSON(e),null,"	"))}}),b.on("shown.bs.modal",function(){b.find(".confirm-import").click(function(b){return a(this).hide(),!0})}).on("hidden.bs.modal",function(){b.remove()}).modal("show")})},c.prototype.reorderUnits=function(b){if(b.preventDefault(),"undefined"==typeof this.reorder_button.attr("disabled")){var c,d={},e=[],f=!1;if(a(this.units).each(function(b,g){c=+g.position.val(),a.inArray(c,e)>-1?(bootstrap_alert("You used the position "+c+" more than once, therefore the new order could not be saved. <a href='#run_unit_"+g.run_unit_id+"'>Click here to scroll to the duplicated position.</a>","Error.",".run_units"),f=!0):(d[g.run_unit_id]=c,e.push(c))}),!f)return a.ajax({url:this.reorder_button.attr("href"),dataType:"html",method:"POST",data:{position:d}}).done(a.proxy(function(b){a(this.units).each(function(a,b){b.position_changed=!1}),this.reorder_button.removeClass("btn-info").attr("disabled","disabled");var c=e.join(","),d=e.sort(function(a,b){return a-b}).join(",");if(this.form.find(".pos_changed").removeClass("pos_changed"),c!=d){var f=this.form;a(this.units.sort(function(a,b){return+a.position.val()-+b.position.val()})).each(function(a,b){f.find(".run_units").append(b.block)})}},this)).fail(ajaxErrorHandling),!1}},c.prototype.lock=function(b,c){c.find(".import_run_units, .run_unit_description, .position, .remove_unit_from_run, .reorder_units, .unit_save, .form-control, select, .from_days, .add_run_unit").each(function(c,d){b?(d.onclick&&(d.onclick_disabled=d.onclick,d.onclick=function(a){return a.preventDefault(),!1}),a(d).attr("data-old_disabled",a(d).attr("disabled")),a(d).attr("disabled","disabled")):(d.onclick_disabled&&(d.onclick=d.onclick_disabled),a(d).attr("data-old-disabled")&&""!==a(d).attr("data-old-disabled")?a(d).attr("disabled",a(d).attr("data-old-disabled")):a(d).removeAttr("disabled"))})},c.prototype.publicToggle=function(b){var c=a(this);return c.parents(".btn-group").find(".btn-checked").removeClass("btn-checked"),c.toggleClass("btn-checked",1),a.ajax({url:c.attr("href"),dataType:"html",method:"POST"}).fail(ajaxErrorHandling),!1},c.prototype.panic=function(b){var c={content:"<h4>Are you really panicking?</h4>",yes_url:this.url+"/panic",no_url:"javascript:void(0);"},d=a(a.parseHTML(getHTMLTemplate("tpl-confirmation",c))).attr("id","run-panic-dialog");d.on("shown.bs.modal",function(){d.find(".btn-yes").click(function(b){document.location=a(this).data("yes")})}).on("hidden.bs.modal",function(){d.remove()}).modal("show")},a(function(){a(".edit_run").each(function(b,d){new c(a(d))})})}(jQuery);